<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Список Креативов</title>
    <script>
        async function loadData() {
            try {
                const response = await fetch(`data/data.csv?nocache=${new Date().getTime()}`);
                const text = await response.text();
                
                if (!text.trim()) {
                    console.error("CSV файл пуст");
                    return;
                }
                
                const rows = text.split('\n').map(row => {
                    return row.match(/(?:"([^"]+)")|([^,]+)/g)?.map(cell => cell.replace(/^"|"$/g, '')) || [];
                }).filter(row => row.length > 1);
                
                if (rows.length < 2) {
                    console.error("CSV содержит только заголовки или пустые строки");
                    return;
                }
                
                const table = document.getElementById('dataTable');
                const headerRow = document.createElement('tr');
                
                const mainColumns = ['country', 'advertiser', 'type', 'url'];
                const allColumns = rows[0];
                const detailColumns = allColumns.filter(col => !mainColumns.includes(col));
                
                mainColumns.forEach(col => {
                    if (!allColumns.includes(col)) {
                        console.warn(`Колонка ${col} отсутствует в файле`);
                        return;
                    }
                    const th = document.createElement('th');
                    th.textContent = col;
                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);
                
                rows.slice(1).forEach((row, index) => {
                    if (!row[allColumns.indexOf('country')]) return; // Пропускаем пустые строки
                    
                    const tr = document.createElement('tr');
                    tr.classList.add('clickable-row');
                    
                    mainColumns.forEach(col => {
                        const colIndex = allColumns.indexOf(col);
                        if (colIndex === -1) return;
                        const td = document.createElement('td');
                        td.textContent = row[colIndex] || '';
                        tr.appendChild(td);
                    });
                    
                    const detailsRow = document.createElement('tr');
                    detailsRow.classList.add('details-row');
                    detailsRow.style.display = 'none';
                    
                    const detailsCell = document.createElement('td');
                    detailsCell.setAttribute('colspan', mainColumns.length);
                    detailsCell.innerHTML = `<div class='details-content' id='details-${index}'></div>`;
                    detailsRow.appendChild(detailsCell);
                    
                    table.appendChild(tr);
                    table.appendChild(detailsRow);
                    
                    tr.addEventListener('click', () => toggleDetails(index, detailsRow, row, allColumns, detailColumns));
                });
            } catch (error) {
                console.error("Ошибка загрузки CSV", error);
            }
        }

        async function toggleDetails(index, row, rowData, allColumns, detailColumns) {
            if (row.style.display === 'none') {
                row.style.display = 'table-row';
                await loadCreativeDetails(index, rowData, allColumns, detailColumns);
            } else {
                row.style.display = 'none';
            }
        }

        async function loadCreativeDetails(index, rowData, allColumns, detailColumns) {
            const detailsContainer = document.getElementById(`details-${index}`);
            if (!detailsContainer) return;

            let detailsHtml = '<h3>Детали Креатива</h3>';
            detailsHtml += '<table class="details-table">';
            
            detailColumns.forEach(col => {
                const colIndex = allColumns.indexOf(col);
                if (colIndex === -1) return;
                detailsHtml += `<tr><th>${col}</th><td>${rowData[colIndex] || ''}</td></tr>`;
            });
            detailsHtml += '</table>';

            // Загружаем HTML-код
            const htmlIndex = allColumns.indexOf('html code');
            if (htmlIndex !== -1 && rowData[htmlIndex]) {
                const htmlFile = rowData[htmlIndex].trim();
                try {
                    const htmlResponse = await fetch(`html/${htmlFile}`);
                    if (htmlResponse.ok) {
                        const htmlContent = await htmlResponse.text();
                        detailsHtml += `<h4>HTML-код:</h4><div class='html-content'>${htmlContent}</div>`;
                    } else {
                        detailsHtml += `<h4>HTML-код:</h4><div class='html-content'>Файл ${htmlFile} не найден</div>`;
                    }
                } catch (e) {
                    detailsHtml += `<h4>HTML-код:</h4><div class='html-content'>Ошибка загрузки файла</div>`;
                }
            }
            
            detailsContainer.innerHTML = detailsHtml;
        }

        window.onload = loadData;
    </script>
    <style>
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; border: 1px solid black; text-align: left; }
        .clickable-row:hover { background-color: #f1f1f1; cursor: pointer; }
        .details-row { background-color: #f9f9f9; }
        .details-table th, .details-table td { padding: 6px; border: 1px solid gray; }
        .html-content { background: #eee; padding: 10px; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Список Креативов</h1>
    <table id="dataTable"></table>
</body>
</html>
